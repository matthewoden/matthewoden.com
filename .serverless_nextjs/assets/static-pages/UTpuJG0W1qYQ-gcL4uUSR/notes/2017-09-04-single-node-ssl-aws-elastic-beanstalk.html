<!DOCTYPE html><html lang="en"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="192x192" href="/static/favicons/favicon-192x192.png"/><link rel="icon" type="image/png" sizes="512x512" href="/static/favicons/favicon-512x512.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/index.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" media="print"/><noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap"/></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if(!e)return localStorage.setItem('theme','light'),d.add('light');if("system"===e){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/matthewoden"/><meta name="twitter:creator" content="https://twitter.com/matthewoden"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="600"/><meta property="og:locale" content="en-us"/><meta name="author" content="Matthew Oden Potter"/><title>Setting up SSL for a single-instance deploy on Elastic Beanstalk, with Docker – MatthewOden.com</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="A step by step guide to have https on your personal projects."/><meta property="og:url" content="https://matthewoden.com/notes/2017-09-04-single-node-ssl-aws-elastic-beanstalk"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2017-09-04T00:00:00.000Z"/><meta property="article:modified_time" content="2017-09-04T00:00:00.000Z"/><meta property="article:author" content="https://matthewoden.com/about"/><meta property="article:tag" content="devops"/><meta property="article:tag" content="docker"/><meta property="og:title" content="Setting up SSL for a single-instance deploy on Elastic Beanstalk, with Docker"/><meta property="og:description" content="A step by step guide to have https on your personal projects."/><meta property="og:image" content="https://matthewoden.com/static/images/face.png"/><meta property="og:image:alt" content="Setting up SSL for a single-instance deploy on Elastic Beanstalk, with Docker"/><link rel="canonical" href="https://matthewoden.com/notes/2017-09-04-single-node-ssl-aws-elastic-beanstalk"/><meta name="twitter:image" content="https://matthewoden.com/static/images/face.png"/><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://matthewoden.com/notes/2017-09-04-single-node-ssl-aws-elastic-beanstalk"
    },
    "headline": "Setting up SSL for a single-instance deploy on Elastic Beanstalk, with Docker",
    "image": [
      "[object Object]"
     ],
    "datePublished": "2017-09-04T00:00:00.000Z",
    "dateModified": "2017-09-04T00:00:00.000Z",
    "author": {"@type": "Person","name": "Matthew Oden Potter"},
    "publisher": {
      "@type": "Organization",
      "name": "Matthew Oden Potter",
      "logo": {
        "@type": "ImageObject",
        "url": "undefined"
      }
    },
    "description": "A step by step guide to have https on your personal projects."
  }</script><meta name="next-head-count" content="28"/><link rel="preload" href="/_next/static/css/40c272ad66e3b5045f49.css" as="style"/><link rel="stylesheet" href="/_next/static/css/40c272ad66e3b5045f49.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-a837451738e9bc430433.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.3001023d071dd3bbe4b7.js" as="script"/><link rel="preload" href="/_next/static/chunks/9adc93607ca194fe33d5fd75450ccdb7397e9788.9fbf4a83f1e2236cbcd2.js" as="script"/><link rel="preload" href="/_next/static/chunks/36831c9346731e813c333dbc96f1dae7f0140181.0be75cecccf812d630d3.js" as="script"/><link rel="preload" href="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.56bb5d8090d059ec8b57.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-443197cdf2ed8c4b363a.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/notes/%5Bslug%5D-771ca72895c067407b5c.js" as="script"/></head><body class="antialiased bg-gray-900 text-white"><div id="__next"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a href="/"><div class="flex items-center justify-between"><div class="h-6 text-2xl font-semibold">MatthewOden.com</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium sm:p-4 text-gray-100" href="/notes">Notes</a><a class="p-1 font-medium sm:p-4 text-gray-100" href="/tags">Tags</a><a class="p-1 font-medium sm:p-4 text-gray-100" href="/about">About</a></div><div class="sm:hidden"><button type="button" class="w-8 h-8 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-100" href="/notes">Notes</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><article><div class="xl:divide-y xl:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-400"><time dateTime="2017-09-04">Sunday, September 3, 2017</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Setting up SSL for a single-instance deploy on Elastic Beanstalk, with Docker</h1></div></div></header><div class="pb-8 divide-y xl:divide-y-0 divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b  xl:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="/static/images/face.png" alt="avatar" class="w-10 h-10 rounded-full"/><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-100">Matthew Oden Potter</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/matthewoden" class="text-blue-500 hover:text-blue-400">@matthewoden</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose prose-dark max-w-none"><div><p>When I was developing <a target="_blank" rel="noopener noreferrer" href="https://gunshotsorfireworks.com">Gunshots or Fireworks</a>,
I decided to experiment with <a target="_blank" rel="noopener noreferrer" href="https://aws.amazon.com/elasticbeanstalk/">AWS&#x27;s Elastic Beanstalk</a>
for deployment.</p><p>If you&#x27;ve never used Elastic Beanstalk before, it&#x27;s an opinionated wrapper around
AWS CloudFormation. In exchange for the full freedom and control of AWS, you
get speed. The main focus is be around taking your application from running
locally to fully deployed in a matter of minutes. Which seemed perfect for a
little toy project like mine.</p><p>My project didn&#x27;t have huge requirements - I only needed to run on a t2.nano.
The only tricky bit came from my use of the browser&#x27;s Geolocation API, which meant
I needed my app served via HTTPS. That can be awkward for a single-container
environment. While setting up an Elastic Load Balancer would make HTTPS easy,
it&#x27;d easily triple my costs.</p><p>Elastic Beanstalk doesn&#x27;t expect you to load-balance single-container
environments, though. Instead, they provide a pre-configured instance of nginx
on container itself. It&#x27;s a nice little feature that keeps your app independent
of any proxy logic. When a small app needs to scale up, it&#x27;s only a configuration
change, rather than a code change.</p><p>There&#x27;s no UI option to configure nginx. Instead, each deployment must provide
<a target="_blank" rel="noopener noreferrer" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html">one or more <code>.ebextension</code> files</a>
to handle container configuration. These files let you modify AWS Resources, run
bash scripts, grab dependancies from package managers, and more.</p><p>If you&#x27;re not familiar with SSL, Nginx, or AWS, configuring your environment
could take a while. Below, you&#x27;ll find the baseline configuration needed
to get up and running, along with an explanation of what&#x27;s happening at each
step. Hopefully it&#x27;ll save you a few hours of scrounging the docs.</p><h2 id="the-plan-set-up-https-once-never-think-about-it-ever-again"><a href="#the-plan-set-up-https-once-never-think-about-it-ever-again" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>The plan: Set up HTTPS once, never think about it ever again.</h2><p>Currently, this configuration does the following:</p><ul><li>Terminates TLS on the proxy, forwarding requests to port <code>80</code> on the docker
application itself.</li><li>Modifies your deployment environment to allows access to your deployment on
port <code>443</code>.</li><li>Automatically upgrades all requests to port <code>443</code> if they come in on port <code>80</code></li><li>Installs certbot on the container instance.</li><li>handles initial certificate creation.</li><li>schedules a daily certificate renewal check.</li></ul><p>So let&#x27;s get started! If you haven&#x27;t already, create a <code>.ebextension</code> directory at the root of
your project. In that directory, create a new file called <code>https-instance.config</code>. We&#x27;ll
be adding options to this file in parts. At each new step, add the options shown
to the end of the file.</p><h2 id="step-1-define-aws-resources"><a href="#step-1-define-aws-resources" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Step 1. Define AWS Resources</h2><p>The first thing we need to make sure we can even accept HTTPS traffic. We
need the security group that&#x27;s created with our environment to allow access
on port 443. This is the first and only CloudFormation rule of our configuration.</p><p>We&#x27;ll set our port range from and to <code>443</code> which limits SSL ingress
to just that port. To apply it to our security group, we&#x27;re using the <code>getAtt</code>
function to grab the GroupId &quot;Attribute&quot; off of the environment&#x27;s security group.</p><pre class="language-yaml"><code class="language-yaml"><span class="">Resources</span><span class="text-code-white">:</span>
  <span class="text-gray-400 italic"># configure our securty group for port 443.</span>
  <span class="">sslSecurityGroupIngress</span><span class="text-code-white">:</span>
    <span class="">Type</span><span class="text-code-white">:</span> AWS<span class="text-code-white">:</span><span class="text-code-white">:</span>EC2<span class="text-code-white">:</span><span class="text-code-white">:</span>SecurityGroupIngress
    <span class="">Properties</span><span class="text-code-white">:</span>
      <span class="">GroupId</span><span class="text-code-white">:</span> <span class="text-code-white">{</span> <span class="">&#x27;Fn::GetAtt&#x27;</span><span class="text-code-white">:</span> <span class="text-code-white">[</span><span class="text-code-green">&#x27;AWSEBSecurityGroup&#x27;</span><span class="text-code-white">,</span> <span class="text-code-green">&#x27;GroupId&#x27;</span><span class="text-code-white">]</span> <span class="text-code-white">}</span>
      <span class="">IpProtocol</span><span class="text-code-white">:</span> tcp
      <span class="">ToPort</span><span class="text-code-white">:</span> <span class="">443</span>
      <span class="">FromPort</span><span class="text-code-white">:</span> <span class="">443</span>
      <span class="">CidrIp</span><span class="text-code-white">:</span> 0.0.0.0/0
</code></pre><blockquote><p><strong>Note:</strong> If you&#x27;re configuring a pre-existing deployment environment, you may also need to
enable access to your security group on port <code>443</code> though the AWS console.</p></blockquote><h2 id="step-2-configure-nginx"><a href="#step-2-configure-nginx" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Step 2. Configure Nginx</h2><p>Next we&#x27;ll be adding a few &quot;files&quot; outside of our application to configure
our nginx instance. First, let&#x27;s set up a tiny little server that upgrades
traffic from HTTP to HTTPS.</p><pre class="language-yaml"><code class="language-yaml"><span class="">files</span><span class="text-code-white">:</span>
  <span class="text-gray-400 italic"># redirect http to docker server.</span>
  <span class="">/etc/nginx/conf.d/http_custom_proxy.conf</span><span class="text-code-white">:</span>
    <span class="">mode</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;000644&#x27;</span>
    <span class="">owner</span><span class="text-code-white">:</span> root
    <span class="">group</span><span class="text-code-white">:</span> root
    <span class="">content</span><span class="text-code-white">:</span> <span class="text-code-white">|</span><span class="">
      server {
        listen 80;
        return 301 https://$host$request_uri;
      }</span>
</code></pre><p>Next, we&#x27;ll add server configuration for handling TLS termination.
This file has all of our SSL options, the locations for our certificates, and
a proxy to our application.</p><pre class="language-yaml"><code class="language-yaml"><span class="">/etc/nginx/conf.d/https_custom.pre</span><span class="text-code-white">:</span>
  <span class="">mode</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;000644&#x27;</span>
  <span class="">owner</span><span class="text-code-white">:</span> root
  <span class="">group</span><span class="text-code-white">:</span> root
  <span class="">content</span><span class="text-code-white">:</span> <span class="text-code-white">|</span><span class="">
    # HTTPS Server</span>

    server <span class="text-code-white">{</span>
      listen 443;
      server_name localhost;

      ssl on;

      ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;
      ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;

      ssl_session_timeout 5m;

      ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
      ssl_ciphers &quot;EECDH+AESGCM<span class="text-code-white">:</span>EDH+AESGCM<span class="text-code-white">:</span>AES256+EECDH<span class="text-code-white">:</span>AES256+EDH&quot;;
      ssl_prefer_server_ciphers on;

      location / <span class="text-code-white">{</span>
        proxy_pass http<span class="text-code-white">:</span>//docker;
        proxy_http_version 1.1;

        proxy_set_header Connection &quot;&quot;;
        proxy_set_header Host $host;
        proxy_set_header X<span class="text-code-white">-</span>Real<span class="text-code-white">-</span>IP $remote_addr;
        proxy_set_header X<span class="text-code-white">-</span>Forwarded<span class="text-code-white">-</span>For $proxy_add_x_forwarded_for;
      <span class="text-code-white">}</span>
    <span class="text-code-white">}</span>
</code></pre><blockquote><p>Did you notice that the file extension is <code>.pre</code> on this file? We&#x27;ll change that to
the standard <code>.conf</code> once we&#x27;ve actually created the certificate files.</p></blockquote><h2 id="step-3-container-configuration"><a href="#step-3-container-configuration" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Step 3. Container Configuration</h2><p>By this point, we&#x27;ve opened up incoming traffic, and we&#x27;re sending everything to
our app. All that&#x27;s left is grab a few dependencies, and install certbot.</p><p>There are two options presented here - packages, and container commands. The
packages option lets us use a few existing package managers, and container
commands are individual bash scripts, run in alphabetical/numeric order.</p><p>We&#x27;ll use the packages option to grab <a target="_blank" rel="noopener noreferrer" href="https://fedoraproject.org/wiki/EPEL">EPEL</a>
which is required by certbot.</p><pre class="language-yaml"><code class="language-yaml"><span class="">packages</span><span class="text-code-white">:</span>
  <span class="">yum</span><span class="text-code-white">:</span>
    <span class="">epel-release</span><span class="text-code-white">:</span> <span class="text-code-white">[</span><span class="text-code-white">]</span>
</code></pre><p>Then we kick off a series of container commands to install certbot, and handle
automatic renewal.</p><pre class="language-yaml"><code class="language-yaml"><span class="">container_commands</span><span class="text-code-white">:</span>
  <span class="">00_create_dir</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;mkdir -p /opt/certbot&#x27;</span>
  <span class="">10_installcertbot</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;wget https://dl.eff.org/certbot-auto  -O /opt/certbot/certbot-auto&#x27;</span>
  <span class="">20_permission</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;chmod a+x /opt/certbot/certbot-auto&#x27;</span>
  <span class="">30_getcert</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;sudo /opt/certbot/certbot-auto certonly --debug --non-interactive --email YOUR_EMAIL@YOUR_DOMAIN.com --agree-tos --standalone --domains YOUR_DOMAIN_HERE --keep-until-expiring --pre-hook &quot;sudo initctl stop nginx&quot; &#x27;</span>
  <span class="">40_link</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;ln -sf /etc/letsencrypt/live/YOUR_DOMAIN_HERE /etc/letsencrypt/live/ebcert&#x27;</span>
  <span class="">50_config</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;mv /etc/nginx/conf.d/https_custom.pre /etc/nginx/conf.d/https_custom.conf&#x27;</span>
  <span class="">60_restartnginx</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> <span class="text-code-green">&#x27;sudo initctl restart nginx&#x27;</span>
  <span class="">70_setrenewal</span><span class="text-code-white">:</span>
    <span class="">command</span><span class="text-code-white">:</span> &#x27;(crontab <span class="text-code-white">-</span>l ; echo &#x27;&#x27;0 6 * * * root /opt/certbot/certbot<span class="text-code-white">-</span>auto renew <span class="text-code-white">-</span><span class="text-code-white">-</span>standalone <span class="text-code-white">-</span><span class="text-code-white">-</span>pre<span class="text-code-white">-</span>hook &quot;service nginx stop&quot; <span class="text-code-white">-</span><span class="text-code-white">-</span>post<span class="text-code-white">-</span>hook &quot;service nginx start&quot; <span class="text-code-white">-</span><span class="text-code-white">-</span>force<span class="text-code-white">-</span>renew&#x27;&#x27;) <span class="text-code-white">|</span> crontab <span class="text-code-white">-</span>&#x27;
</code></pre><p>It seems like there&#x27;s a lot going on here, but it&#x27;s mostly just paths. Even so,
it might be a good idea to go over what&#x27;s happening at each step:</p><ul><li><code>00_create_dir</code> Create the working directory for certbot, if needed.</li><li><code>10_installcertbot</code> Download certbot to our newly created directory.</li><li><code>20_permission</code> Set certbot as executable.</li><li><code>30_getcert</code> Get our first cert, if needed. We&#x27;re using the standalone option
over the nginx plugin for stability.<ul><li>Remember to change the email and domain lines!</li></ul></li><li><code>40_link</code> Create a simlink between the our location of our certs, (which is
domain specific) the live directory in our configuration (which is reusable).</li><li><code>50_config</code> Now that we have certs in the right directory, we can rename our
ssl config from <code>.pre</code> to <code>.conf</code>.</li><li><code>60_restartnginx</code> Restart nginx to ensure that all of our options are set.</li><li><code>70_setrenewal</code> Lists out the current cronjobs, and adds on a new one for our
certbot renewal. All of which gets joined together, and piped back into crontab.<ul><li>Note that our new cron job does stop and start nginx during renewal.</li></ul></li></ul><p>And that&#x27;s it! If you&#x27;ve been following along, you should have a single
configuration file that&#x27;s fairly reusable, and ready for your next <code>eb deploy</code>.
If you have any questions, feel free to hit me up in the comments.</p></div></div><div class="pt-6 pb-6 text-sm text-gray-700 text-gray-300"><a target="_blank" rel="nofollow" href="https://mobile.twitter.com/search?q=https%3A%2F%2Fmatthewoden.com%2Fnotes%2F2017-09-04-single-node-ssl-aws-elastic-beanstalk">Discuss on Twitter</a> • <a target="_blank" rel="noopener noreferrer" href="https://github.com/matthewoden/matthewoden.com/blob/master/data/notes/2017-09-04-single-node-ssl-aws-elastic-beanstalk.md">View on GitHub</a></div></div><footer><div class="text-sm font-medium leading-5 xl:divide-y divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide uppercase text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-xs font-medium text-blue-500 lowercase hover:text-blue-400" href="/tags/devops">devops</a><a class="mr-3 text-xs font-medium text-blue-500 lowercase hover:text-blue-400" href="/tags/docker">docker</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide  uppercase text-gray-400">Previous Article</h2><div class="text-blue-500 hover:text-blue-400"><a href="/notes/2017-09-02-the-golden-rule-of-node-never-do-work">Node isn&#x27;t where you do work.</a></div></div><div><h2 class="text-xs tracking-wide uppercase text-gray-400">Next Article</h2><div class="text-blue-500 hover:text-blue-400"><a href="/notes/2021-02-14-converting-from-k3s-to-docker-swarm">Converting from K3s to Docker Swarm</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-blue-500 hover:text-blue-400" href="/notes">← Back to Notes</a></div></footer></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:heymatthewoden@gmail.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-200 hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/matthewoden"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-200 hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/matthewoden"><span class="sr-only">twitter</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-200 hover:text-blue-400 h-6 w-6"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/matthew-potter-8194998a/"><span class="sr-only">linkedin</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-200 hover:text-blue-400 h-6 w-6"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-400"><div>Matthew Oden Potter</div><div> • </div><div>© 2017</div><div> • </div><a href="/">MatthewOden.com</a></div><div class="mb-8 text-sm text-gray-400"> </div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":{"compiledSource":"\"use strict\";\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i \u003c arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i \u003c sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i \u003c sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\n\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"When I was developing \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://gunshotsorfireworks.com\"\n  }), \"Gunshots or Fireworks\"), \",\\nI decided to experiment with \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://aws.amazon.com/elasticbeanstalk/\"\n  }), \"AWS's Elastic Beanstalk\"), \"\\nfor deployment.\"), mdx(\"p\", null, \"If you've never used Elastic Beanstalk before, it's an opinionated wrapper around\\nAWS CloudFormation. In exchange for the full freedom and control of AWS, you\\nget speed. The main focus is be around taking your application from running\\nlocally to fully deployed in a matter of minutes. Which seemed perfect for a\\nlittle toy project like mine.\"), mdx(\"p\", null, \"My project didn't have huge requirements - I only needed to run on a t2.nano.\\nThe only tricky bit came from my use of the browser's Geolocation API, which meant\\nI needed my app served via HTTPS. That can be awkward for a single-container\\nenvironment. While setting up an Elastic Load Balancer would make HTTPS easy,\\nit'd easily triple my costs.\"), mdx(\"p\", null, \"Elastic Beanstalk doesn't expect you to load-balance single-container\\nenvironments, though. Instead, they provide a pre-configured instance of nginx\\non container itself. It's a nice little feature that keeps your app independent\\nof any proxy logic. When a small app needs to scale up, it's only a configuration\\nchange, rather than a code change.\"), mdx(\"p\", null, \"There's no UI option to configure nginx. Instead, each deployment must provide\\n\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html\"\n  }), \"one or more \", mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \".ebextension\"), \" files\"), \"\\nto handle container configuration. These files let you modify AWS Resources, run\\nbash scripts, grab dependancies from package managers, and more.\"), mdx(\"p\", null, \"If you're not familiar with SSL, Nginx, or AWS, configuring your environment\\ncould take a while. Below, you'll find the baseline configuration needed\\nto get up and running, along with an explanation of what's happening at each\\nstep. Hopefully it'll save you a few hours of scrounging the docs.\"), mdx(\"h2\", {\n    \"id\": \"the-plan-set-up-https-once-never-think-about-it-ever-again\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#the-plan-set-up-https-once-never-think-about-it-ever-again\",\n    \"aria-hidden\": \"true\",\n    \"tabIndex\": -1\n  }), mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"icon icon-link\"\n  }))), \"The plan: Set up HTTPS once, never think about it ever again.\"), mdx(\"p\", null, \"Currently, this configuration does the following:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Terminates TLS on the proxy, forwarding requests to port \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"80\"), \" on the docker\\napplication itself.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Modifies your deployment environment to allows access to your deployment on\\nport \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"443\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Automatically upgrades all requests to port \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"443\"), \" if they come in on port \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"80\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Installs certbot on the container instance.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"handles initial certificate creation.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"schedules a daily certificate renewal check.\")), mdx(\"p\", null, \"So let's get started! If you haven't already, create a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".ebextension\"), \" directory at the root of\\nyour project. In that directory, create a new file called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"https-instance.config\"), \". We'll\\nbe adding options to this file in parts. At each new step, add the options shown\\nto the end of the file.\"), mdx(\"h2\", {\n    \"id\": \"step-1-define-aws-resources\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#step-1-define-aws-resources\",\n    \"aria-hidden\": \"true\",\n    \"tabIndex\": -1\n  }), mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"icon icon-link\"\n  }))), \"Step 1. Define AWS Resources\"), mdx(\"p\", null, \"The first thing we need to make sure we can even accept HTTPS traffic. We\\nneed the security group that's created with our environment to allow access\\non port 443. This is the first and only CloudFormation rule of our configuration.\"), mdx(\"p\", null, \"We'll set our port range from and to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"443\"), \" which limits SSL ingress\\nto just that port. To apply it to our security group, we're using the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"getAtt\"), \"\\nfunction to grab the GroupId \\\"Attribute\\\" off of the environment's security group.\"), mdx(\"pre\", {\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-yaml\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"Resources\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-gray-400 italic\"\n  }), \"# configure our securty group for port 443.\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"sslSecurityGroupIngress\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"Type\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" AWS\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"EC2\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"SecurityGroupIngress\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"Properties\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n      \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"GroupId\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"{\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"'Fn::GetAtt'\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"[\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'AWSEBSecurityGroup'\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \",\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'GroupId'\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"]\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"}\"), \"\\n      \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"IpProtocol\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" tcp\\n      \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"ToPort\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"443\"), \"\\n      \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"FromPort\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"443\"), \"\\n      \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"CidrIp\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" 0.0.0.0/0\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Note:\"), \" If you're configuring a pre-existing deployment environment, you may also need to\\nenable access to your security group on port \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"443\"), \" though the AWS console.\")), mdx(\"h2\", {\n    \"id\": \"step-2-configure-nginx\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#step-2-configure-nginx\",\n    \"aria-hidden\": \"true\",\n    \"tabIndex\": -1\n  }), mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"icon icon-link\"\n  }))), \"Step 2. Configure Nginx\"), mdx(\"p\", null, \"Next we'll be adding a few \\\"files\\\" outside of our application to configure\\nour nginx instance. First, let's set up a tiny little server that upgrades\\ntraffic from HTTP to HTTPS.\"), mdx(\"pre\", {\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-yaml\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"files\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-gray-400 italic\"\n  }), \"# redirect http to docker server.\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"/etc/nginx/conf.d/http_custom_proxy.conf\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"mode\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'000644'\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"owner\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" root\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"group\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" root\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"content\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"|\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"\\n      server {\\n        listen 80;\\n        return 301 https://$host$request_uri;\\n      }\"), \"\\n\")), mdx(\"p\", null, \"Next, we'll add server configuration for handling TLS termination.\\nThis file has all of our SSL options, the locations for our certificates, and\\na proxy to our application.\"), mdx(\"pre\", {\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-yaml\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"/etc/nginx/conf.d/https_custom.pre\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"mode\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'000644'\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"owner\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" root\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"group\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" root\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"content\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"|\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"\\n    # HTTPS Server\"), \"\\n\\n    server \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"{\"), \"\\n      listen 443;\\n      server_name localhost;\\n\\n      ssl on;\\n\\n      ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;\\n      ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;\\n\\n      ssl_session_timeout 5m;\\n\\n      ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\\n      ssl_ciphers \\\"EECDH+AESGCM\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"EDH+AESGCM\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"AES256+EECDH\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"AES256+EDH\\\";\\n      ssl_prefer_server_ciphers on;\\n\\n      location / \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"{\"), \"\\n        proxy_pass http\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"//docker;\\n        proxy_http_version 1.1;\\n\\n        proxy_set_header Connection \\\"\\\";\\n        proxy_set_header Host $host;\\n        proxy_set_header X\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"Real\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"IP $remote_addr;\\n        proxy_set_header X\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"Forwarded\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"For $proxy_add_x_forwarded_for;\\n      \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"}\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"}\"), \"\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Did you notice that the file extension is \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".pre\"), \" on this file? We'll change that to\\nthe standard \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".conf\"), \" once we've actually created the certificate files.\")), mdx(\"h2\", {\n    \"id\": \"step-3-container-configuration\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#step-3-container-configuration\",\n    \"aria-hidden\": \"true\",\n    \"tabIndex\": -1\n  }), mdx(\"span\", _extends({\n    parentName: \"a\"\n  }, {\n    \"className\": \"icon icon-link\"\n  }))), \"Step 3. Container Configuration\"), mdx(\"p\", null, \"By this point, we've opened up incoming traffic, and we're sending everything to\\nour app. All that's left is grab a few dependencies, and install certbot.\"), mdx(\"p\", null, \"There are two options presented here - packages, and container commands. The\\npackages option lets us use a few existing package managers, and container\\ncommands are individual bash scripts, run in alphabetical/numeric order.\"), mdx(\"p\", null, \"We'll use the packages option to grab \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://fedoraproject.org/wiki/EPEL\"\n  }), \"EPEL\"), \"\\nwhich is required by certbot.\"), mdx(\"pre\", {\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-yaml\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"packages\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"yum\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"epel-release\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"[\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"]\"), \"\\n\")), mdx(\"p\", null, \"Then we kick off a series of container commands to install certbot, and handle\\nautomatic renewal.\"), mdx(\"pre\", {\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-yaml\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"container_commands\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"00_create_dir\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'mkdir -p /opt/certbot'\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"10_installcertbot\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'wget https://dl.eff.org/certbot-auto  -O /opt/certbot/certbot-auto'\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"20_permission\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'chmod a+x /opt/certbot/certbot-auto'\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"30_getcert\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'sudo /opt/certbot/certbot-auto certonly --debug --non-interactive --email YOUR_EMAIL@YOUR_DOMAIN.com --agree-tos --standalone --domains YOUR_DOMAIN_HERE --keep-until-expiring --pre-hook \\\"sudo initctl stop nginx\\\" '\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"40_link\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'ln -sf /etc/letsencrypt/live/YOUR_DOMAIN_HERE /etc/letsencrypt/live/ebcert'\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"50_config\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'mv /etc/nginx/conf.d/https_custom.pre /etc/nginx/conf.d/https_custom.conf'\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"60_restartnginx\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-green\"\n  }), \"'sudo initctl restart nginx'\"), \"\\n  \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"70_setrenewal\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \"\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"\"\n  }), \"command\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \":\"), \" '(crontab \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"l ; echo ''0 6 * * * root /opt/certbot/certbot\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"auto renew \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"standalone \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"pre\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"hook \\\"service nginx stop\\\" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"post\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"hook \\\"service nginx start\\\" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"force\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"renew'') \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"|\"), \" crontab \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"text-code-white\"\n  }), \"-\"), \"'\\n\")), mdx(\"p\", null, \"It seems like there's a lot going on here, but it's mostly just paths. Even so,\\nit might be a good idea to go over what's happening at each step:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"00_create_dir\"), \" Create the working directory for certbot, if needed.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"10_installcertbot\"), \" Download certbot to our newly created directory.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"20_permission\"), \" Set certbot as executable.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"30_getcert\"), \" Get our first cert, if needed. We're using the standalone option\\nover the nginx plugin for stability.\", mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Remember to change the email and domain lines!\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"40_link\"), \" Create a simlink between the our location of our certs, (which is\\ndomain specific) the live directory in our configuration (which is reusable).\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"50_config\"), \" Now that we have certs in the right directory, we can rename our\\nssl config from \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \".pre\"), \" to \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \".conf\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"60_restartnginx\"), \" Restart nginx to ensure that all of our options are set.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"70_setrenewal\"), \" Lists out the current cronjobs, and adds on a new one for our\\ncertbot renewal. All of which gets joined together, and piped back into crontab.\", mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Note that our new cron job does stop and start nginx during renewal.\")))), mdx(\"p\", null, \"And that's it! If you've been following along, you should have a single\\nconfiguration file that's fairly reusable, and ready for your next \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"eb deploy\"), \".\\nIf you have any questions, feel free to hit me up in the comments.\"));\n}\n\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"\u003cp\u003eWhen I was developing \u003ca target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://gunshotsorfireworks.com\"\u003eGunshots or Fireworks\u003c/a\u003e,\nI decided to experiment with \u003ca target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://aws.amazon.com/elasticbeanstalk/\"\u003eAWS\u0026#x27;s Elastic Beanstalk\u003c/a\u003e\nfor deployment.\u003c/p\u003e\u003cp\u003eIf you\u0026#x27;ve never used Elastic Beanstalk before, it\u0026#x27;s an opinionated wrapper around\nAWS CloudFormation. In exchange for the full freedom and control of AWS, you\nget speed. The main focus is be around taking your application from running\nlocally to fully deployed in a matter of minutes. Which seemed perfect for a\nlittle toy project like mine.\u003c/p\u003e\u003cp\u003eMy project didn\u0026#x27;t have huge requirements - I only needed to run on a t2.nano.\nThe only tricky bit came from my use of the browser\u0026#x27;s Geolocation API, which meant\nI needed my app served via HTTPS. That can be awkward for a single-container\nenvironment. While setting up an Elastic Load Balancer would make HTTPS easy,\nit\u0026#x27;d easily triple my costs.\u003c/p\u003e\u003cp\u003eElastic Beanstalk doesn\u0026#x27;t expect you to load-balance single-container\nenvironments, though. Instead, they provide a pre-configured instance of nginx\non container itself. It\u0026#x27;s a nice little feature that keeps your app independent\nof any proxy logic. When a small app needs to scale up, it\u0026#x27;s only a configuration\nchange, rather than a code change.\u003c/p\u003e\u003cp\u003eThere\u0026#x27;s no UI option to configure nginx. Instead, each deployment must provide\n\u003ca target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html\"\u003eone or more \u003ccode\u003e.ebextension\u003c/code\u003e files\u003c/a\u003e\nto handle container configuration. These files let you modify AWS Resources, run\nbash scripts, grab dependancies from package managers, and more.\u003c/p\u003e\u003cp\u003eIf you\u0026#x27;re not familiar with SSL, Nginx, or AWS, configuring your environment\ncould take a while. Below, you\u0026#x27;ll find the baseline configuration needed\nto get up and running, along with an explanation of what\u0026#x27;s happening at each\nstep. Hopefully it\u0026#x27;ll save you a few hours of scrounging the docs.\u003c/p\u003e\u003ch2 id=\"the-plan-set-up-https-once-never-think-about-it-ever-again\"\u003e\u003ca href=\"#the-plan-set-up-https-once-never-think-about-it-ever-again\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eThe plan: Set up HTTPS once, never think about it ever again.\u003c/h2\u003e\u003cp\u003eCurrently, this configuration does the following:\u003c/p\u003e\u003cul\u003e\u003cli\u003eTerminates TLS on the proxy, forwarding requests to port \u003ccode\u003e80\u003c/code\u003e on the docker\napplication itself.\u003c/li\u003e\u003cli\u003eModifies your deployment environment to allows access to your deployment on\nport \u003ccode\u003e443\u003c/code\u003e.\u003c/li\u003e\u003cli\u003eAutomatically upgrades all requests to port \u003ccode\u003e443\u003c/code\u003e if they come in on port \u003ccode\u003e80\u003c/code\u003e\u003c/li\u003e\u003cli\u003eInstalls certbot on the container instance.\u003c/li\u003e\u003cli\u003ehandles initial certificate creation.\u003c/li\u003e\u003cli\u003eschedules a daily certificate renewal check.\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eSo let\u0026#x27;s get started! If you haven\u0026#x27;t already, create a \u003ccode\u003e.ebextension\u003c/code\u003e directory at the root of\nyour project. In that directory, create a new file called \u003ccode\u003ehttps-instance.config\u003c/code\u003e. We\u0026#x27;ll\nbe adding options to this file in parts. At each new step, add the options shown\nto the end of the file.\u003c/p\u003e\u003ch2 id=\"step-1-define-aws-resources\"\u003e\u003ca href=\"#step-1-define-aws-resources\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eStep 1. Define AWS Resources\u003c/h2\u003e\u003cp\u003eThe first thing we need to make sure we can even accept HTTPS traffic. We\nneed the security group that\u0026#x27;s created with our environment to allow access\non port 443. This is the first and only CloudFormation rule of our configuration.\u003c/p\u003e\u003cp\u003eWe\u0026#x27;ll set our port range from and to \u003ccode\u003e443\u003c/code\u003e which limits SSL ingress\nto just that port. To apply it to our security group, we\u0026#x27;re using the \u003ccode\u003egetAtt\u003c/code\u003e\nfunction to grab the GroupId \u0026quot;Attribute\u0026quot; off of the environment\u0026#x27;s security group.\u003c/p\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"\"\u003eResources\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"text-gray-400 italic\"\u003e# configure our securty group for port 443.\u003c/span\u003e\n  \u003cspan class=\"\"\u003esslSecurityGroupIngress\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003eType\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e AWS\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003eEC2\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003eSecurityGroupIngress\n    \u003cspan class=\"\"\u003eProperties\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"\"\u003eGroupId\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-white\"\u003e{\u003c/span\u003e \u003cspan class=\"\"\u003e\u0026#x27;Fn::GetAtt\u0026#x27;\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-white\"\u003e[\u003c/span\u003e\u003cspan class=\"text-code-green\"\u003e\u0026#x27;AWSEBSecurityGroup\u0026#x27;\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e,\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;GroupId\u0026#x27;\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e]\u003c/span\u003e \u003cspan class=\"text-code-white\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"\"\u003eIpProtocol\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e tcp\n      \u003cspan class=\"\"\u003eToPort\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"\"\u003e443\u003c/span\u003e\n      \u003cspan class=\"\"\u003eFromPort\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"\"\u003e443\u003c/span\u003e\n      \u003cspan class=\"\"\u003eCidrIp\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e 0.0.0.0/0\n\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\u003cp\u003e\u003cstrong\u003eNote:\u003c/strong\u003e If you\u0026#x27;re configuring a pre-existing deployment environment, you may also need to\nenable access to your security group on port \u003ccode\u003e443\u003c/code\u003e though the AWS console.\u003c/p\u003e\u003c/blockquote\u003e\u003ch2 id=\"step-2-configure-nginx\"\u003e\u003ca href=\"#step-2-configure-nginx\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eStep 2. Configure Nginx\u003c/h2\u003e\u003cp\u003eNext we\u0026#x27;ll be adding a few \u0026quot;files\u0026quot; outside of our application to configure\nour nginx instance. First, let\u0026#x27;s set up a tiny little server that upgrades\ntraffic from HTTP to HTTPS.\u003c/p\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"\"\u003efiles\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"text-gray-400 italic\"\u003e# redirect http to docker server.\u003c/span\u003e\n  \u003cspan class=\"\"\u003e/etc/nginx/conf.d/http_custom_proxy.conf\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003emode\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;000644\u0026#x27;\u003c/span\u003e\n    \u003cspan class=\"\"\u003eowner\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e root\n    \u003cspan class=\"\"\u003egroup\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e root\n    \u003cspan class=\"\"\u003econtent\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-white\"\u003e|\u003c/span\u003e\u003cspan class=\"\"\u003e\n      server {\n        listen 80;\n        return 301 https://$host$request_uri;\n      }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNext, we\u0026#x27;ll add server configuration for handling TLS termination.\nThis file has all of our SSL options, the locations for our certificates, and\na proxy to our application.\u003c/p\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"\"\u003e/etc/nginx/conf.d/https_custom.pre\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"\"\u003emode\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;000644\u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003eowner\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e root\n  \u003cspan class=\"\"\u003egroup\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e root\n  \u003cspan class=\"\"\u003econtent\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-white\"\u003e|\u003c/span\u003e\u003cspan class=\"\"\u003e\n    # HTTPS Server\u003c/span\u003e\n\n    server \u003cspan class=\"text-code-white\"\u003e{\u003c/span\u003e\n      listen 443;\n      server_name localhost;\n\n      ssl on;\n\n      ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;\n      ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;\n\n      ssl_session_timeout 5m;\n\n      ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n      ssl_ciphers \u0026quot;EECDH+AESGCM\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003eEDH+AESGCM\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003eAES256+EECDH\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003eAES256+EDH\u0026quot;;\n      ssl_prefer_server_ciphers on;\n\n      location / \u003cspan class=\"text-code-white\"\u003e{\u003c/span\u003e\n        proxy_pass http\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e//docker;\n        proxy_http_version 1.1;\n\n        proxy_set_header Connection \u0026quot;\u0026quot;;\n        proxy_set_header Host $host;\n        proxy_set_header X\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003eReal\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003eIP $remote_addr;\n        proxy_set_header X\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003eForwarded\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003eFor $proxy_add_x_forwarded_for;\n      \u003cspan class=\"text-code-white\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"text-code-white\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\u003cp\u003eDid you notice that the file extension is \u003ccode\u003e.pre\u003c/code\u003e on this file? We\u0026#x27;ll change that to\nthe standard \u003ccode\u003e.conf\u003c/code\u003e once we\u0026#x27;ve actually created the certificate files.\u003c/p\u003e\u003c/blockquote\u003e\u003ch2 id=\"step-3-container-configuration\"\u003e\u003ca href=\"#step-3-container-configuration\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eStep 3. Container Configuration\u003c/h2\u003e\u003cp\u003eBy this point, we\u0026#x27;ve opened up incoming traffic, and we\u0026#x27;re sending everything to\nour app. All that\u0026#x27;s left is grab a few dependencies, and install certbot.\u003c/p\u003e\u003cp\u003eThere are two options presented here - packages, and container commands. The\npackages option lets us use a few existing package managers, and container\ncommands are individual bash scripts, run in alphabetical/numeric order.\u003c/p\u003e\u003cp\u003eWe\u0026#x27;ll use the packages option to grab \u003ca target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://fedoraproject.org/wiki/EPEL\"\u003eEPEL\u003c/a\u003e\nwhich is required by certbot.\u003c/p\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"\"\u003epackages\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"\"\u003eyum\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003eepel-release\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-white\"\u003e[\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen we kick off a series of container commands to install certbot, and handle\nautomatic renewal.\u003c/p\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"\"\u003econtainer_commands\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"\"\u003e00_create_dir\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;mkdir -p /opt/certbot\u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003e10_installcertbot\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;wget https://dl.eff.org/certbot-auto  -O /opt/certbot/certbot-auto\u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003e20_permission\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;chmod a+x /opt/certbot/certbot-auto\u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003e30_getcert\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;sudo /opt/certbot/certbot-auto certonly --debug --non-interactive --email YOUR_EMAIL@YOUR_DOMAIN.com --agree-tos --standalone --domains YOUR_DOMAIN_HERE --keep-until-expiring --pre-hook \u0026quot;sudo initctl stop nginx\u0026quot; \u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003e40_link\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;ln -sf /etc/letsencrypt/live/YOUR_DOMAIN_HERE /etc/letsencrypt/live/ebcert\u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003e50_config\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;mv /etc/nginx/conf.d/https_custom.pre /etc/nginx/conf.d/https_custom.conf\u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003e60_restartnginx\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u003cspan class=\"text-code-green\"\u003e\u0026#x27;sudo initctl restart nginx\u0026#x27;\u003c/span\u003e\n  \u003cspan class=\"\"\u003e70_setrenewal\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"\"\u003ecommand\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e:\u003c/span\u003e \u0026#x27;(crontab \u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003el ; echo \u0026#x27;\u0026#x27;0 6 * * * root /opt/certbot/certbot\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003eauto renew \u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003estandalone \u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003epre\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003ehook \u0026quot;service nginx stop\u0026quot; \u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003epost\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003ehook \u0026quot;service nginx start\u0026quot; \u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003e\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003eforce\u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003erenew\u0026#x27;\u0026#x27;) \u003cspan class=\"text-code-white\"\u003e|\u003c/span\u003e crontab \u003cspan class=\"text-code-white\"\u003e-\u003c/span\u003e\u0026#x27;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIt seems like there\u0026#x27;s a lot going on here, but it\u0026#x27;s mostly just paths. Even so,\nit might be a good idea to go over what\u0026#x27;s happening at each step:\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003e00_create_dir\u003c/code\u003e Create the working directory for certbot, if needed.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e10_installcertbot\u003c/code\u003e Download certbot to our newly created directory.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e20_permission\u003c/code\u003e Set certbot as executable.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e30_getcert\u003c/code\u003e Get our first cert, if needed. We\u0026#x27;re using the standalone option\nover the nginx plugin for stability.\u003cul\u003e\u003cli\u003eRemember to change the email and domain lines!\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003e\u003ccode\u003e40_link\u003c/code\u003e Create a simlink between the our location of our certs, (which is\ndomain specific) the live directory in our configuration (which is reusable).\u003c/li\u003e\u003cli\u003e\u003ccode\u003e50_config\u003c/code\u003e Now that we have certs in the right directory, we can rename our\nssl config from \u003ccode\u003e.pre\u003c/code\u003e to \u003ccode\u003e.conf\u003c/code\u003e.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e60_restartnginx\u003c/code\u003e Restart nginx to ensure that all of our options are set.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e70_setrenewal\u003c/code\u003e Lists out the current cronjobs, and adds on a new one for our\ncertbot renewal. All of which gets joined together, and piped back into crontab.\u003cul\u003e\u003cli\u003eNote that our new cron job does stop and start nginx during renewal.\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eAnd that\u0026#x27;s it! If you\u0026#x27;ve been following along, you should have a single\nconfiguration file that\u0026#x27;s fairly reusable, and ready for your next \u003ccode\u003eeb deploy\u003c/code\u003e.\nIf you have any questions, feel free to hit me up in the comments.\u003c/p\u003e","scope":{}},"frontMatter":{"wordCount":1134,"readingTime":{"text":"6 min read","minutes":5.66,"time":339600,"words":1132},"slug":"2017-09-04-single-node-ssl-aws-elastic-beanstalk","fileName":"2017-09-04-single-node-ssl-aws-elastic-beanstalk.md","title":"Setting up SSL for a single-instance deploy on Elastic Beanstalk, with Docker","date":"2017-09-04","tags":["devops","docker"],"draft":false,"summary":"A step by step guide to have https on your personal projects."}},"prev":{"title":"Node isn't where you do work.","date":"2017-09-02","summary":"Push work to other systems, and let node coordinate your flow.","tags":["node","architecture"],"slug":"2017-09-02-the-golden-rule-of-node-never-do-work"},"next":{"title":"Converting from K3s to Docker Swarm","date":"2021-02-14","tags":["devops","docker"],"draft":false,"summary":"Sometimes, it's nice to scale down the homelab to something a little simpler.","slug":"2021-02-14-converting-from-k3s-to-docker-swarm"}},"__N_SSG":true},"page":"/notes/[slug]","query":{"slug":"2017-09-04-single-node-ssl-aws-elastic-beanstalk"},"buildId":"UTpuJG0W1qYQ-gcL4uUSR","runtimeConfig":{},"nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-0b9b5722f0d6cfa79d03.js"></script><script src="/_next/static/chunks/main-a837451738e9bc430433.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/commons.3001023d071dd3bbe4b7.js" async=""></script><script src="/_next/static/chunks/9adc93607ca194fe33d5fd75450ccdb7397e9788.9fbf4a83f1e2236cbcd2.js" async=""></script><script src="/_next/static/chunks/36831c9346731e813c333dbc96f1dae7f0140181.0be75cecccf812d630d3.js" async=""></script><script src="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.56bb5d8090d059ec8b57.js" async=""></script><script src="/_next/static/chunks/pages/_app-443197cdf2ed8c4b363a.js" async=""></script><script src="/_next/static/chunks/pages/notes/%5Bslug%5D-771ca72895c067407b5c.js" async=""></script><script src="/_next/static/UTpuJG0W1qYQ-gcL4uUSR/_buildManifest.js" async=""></script><script src="/_next/static/UTpuJG0W1qYQ-gcL4uUSR/_ssgManifest.js" async=""></script></body></html>